define(function(require,a,b){"use strict";function c(a){var b=a.data("id"),c=a.data("album"),d=i[b],e=new g.Deferred;return b?d?e.resolve(d):h.subjectList(c).done(function(a){var c=h.findById(a,b);c?(d=h.fmLink(c.sid,c.ssid),i[b]=d,e.resolve(d)):e.reject()}).fail(function(){e.reject()}):e.reject(),e.promise()}function d(){var a=g("#song_list_tmpl"),b=a.html(),d="";a.length&&(d='<p class="song_title"><a class="fm-improve-mine-link" data-album="{%=s.path%}" data-id="{%=s.id%}" href="javascript:" target="_fm" title="在 FM 播放该首歌">{%=s.title%}</a></p>',b=b.replace('<p class="song_title">{%=s.title%}</p>',d),a.html(b),g("#record_viewer").on("click",".fm-improve-mine-link",function(){var a=g(this),b=a.attr("href")||"",d=a.attr("target")||"_fm",e=c(a);if(b.match(/^javascript/)){var f="",h=null;setTimeout(function(){f=f?f:"/",h=window.open(f,d),h.focus()},300),e.done(function(b){a.attr("href",b),h?(h.location.href=b,h=null):f=b}).fail(function(){a.attr("title","找不到播放链接")})}}))}function e(){var a=g("#chl_list_tmpl"),b=a.html();a.length&&(b=b.replace(/target="_blank"/g,'target="_fm"'),a.html(b))}function f(){e(),d()}var g=require("jquery"),h=require("js/helper"),i={};b.exports={init:f}});