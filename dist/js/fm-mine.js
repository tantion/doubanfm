define("js/fm-mine",function(require,a,b){"use strict";function c(a,b){var c=l[a],d=new j.Deferred;return a&&b.match(/http:\/\/music\.douban\.com\/subject\/\d+\//i)?c?d.resolve(c):k.subjectList(b).done(function(b){var e=k.findById(b,a);e?(c=k.fmLink(e.sid,e.ssid),l[a]=c,d.resolve(c)):d.reject()}).fail(function(){d.reject()}):d.reject(),d.promise()}function d(a,b,d){var e=null,f=new j.Deferred,g=!1,h="";return d=d||"_fm",setTimeout(function(){g||(h=h?h:"http://douban.fm/",e=window.open(h,d),e.focus())},500),c(a,b).done(function(a){h=a,e&&(e.location.href=a),f.resolve(a)}).fail(function(){g=!0,f.reject()}),f.promise()}function e(){var a=j("#song_list_tmpl"),b=a.html(),c="";a.length&&(c='<p class="song_title"><a class="fm-improve-mine-link" data-album="{%=s.path%}" data-id="{%=s.id%}" href="javascript:" target="_fm" title="在 FM 播放该首歌">{%=s.title%}</a></p>',b=b.replace('<p class="song_title">{%=s.title%}</p>',c),a.html(b),j("#record_viewer").on("click",".fm-improve-mine-link",function(a){var b=j(this),c=b.attr("href")||"",e=b.attr("target")||"_fm",f=b.data("id"),g=b.data("album");c.match(/^javascript/)&&(a.preventDefault(),d(f,g,e).done(function(a){b.attr("href",a)}).fail(function(){b.attr("title","抱歉没有找到播放地址")}))}))}function f(){var a=j("#chl_list_tmpl"),b=a.html();a.length&&(b=b.replace(/target="_blank"/g,'target="_fm"'),a.html(b))}function g(a){var b=new j.Deferred;return j.ajax({type:"get",url:a,dataType:"json",timeout:3e4}).done(function(a){a&&"liked"===a.song_type?b.resolve(a):b.reject()}).fail(function(){b.reject()}),b.promise()}function h(){chrome.runtime.onMessage.addListener(function(a,b,c){return g(a.url).done(function(a){c(a)}).fail(function(){c()}),!0})}function i(){location.href.match(/douban\.fm\/mine/i)&&(f(),e(),h())}var j=require("jquery"),k=require("js/helper"),l={};b.exports={findFMLink:c,playInFM:d,init:i}});