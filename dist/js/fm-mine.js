define("js/fm-mine",function(require,a,b){"use strict";function c(a){var b=a.data("id"),c=a.data("album"),d=k[b],e=new i.Deferred;return b&&c.match(/http:\/\/music\.douban\.com\/subject\/\d+\//i)?d?e.resolve(d):j.subjectList(c).done(function(a){var c=j.findById(a,b);c?(d=j.fmLink(c.sid,c.ssid),k[b]=d,e.resolve(d)):e.reject()}).fail(function(){e.reject()}):e.reject(),e.promise()}function d(){var a=i("#song_list_tmpl"),b=a.html(),d="";a.length&&(d='<p class="song_title"><a class="fm-improve-mine-link" data-album="{%=s.path%}" data-id="{%=s.id%}" href="javascript:" target="_fm" title="在 FM 播放该首歌">{%=s.title%}</a></p>',b=b.replace('<p class="song_title">{%=s.title%}</p>',d),a.html(b),i("#record_viewer").on("click",".fm-improve-mine-link",function(){var a=i(this),b=a.attr("href")||"",d=a.attr("target")||"_fm",e=c(a);if(b.match(/^javascript/)){var f=null,g=!1,h="";setTimeout(function(){g||(h=h?h:"/",f=window.open(h,d),f.focus())},500),e.done(function(b){a.attr("href",b),h=b,f&&(f.location.href=b)}).fail(function(){g=!0,a.attr("title","找不到播放链接")})}}))}function e(){var a=i("#chl_list_tmpl"),b=a.html();a.length&&(b=b.replace(/target="_blank"/g,'target="_fm"'),a.html(b))}function f(a){var b=new i.Deferred;return i.ajax({type:"get",url:a,dataType:"json",timeout:3e4}).done(function(a){a&&"liked"===a.song_type?b.resolve(a):b.reject()}).fail(function(){b.reject()}),b.promise()}function g(){chrome.runtime.onMessage.addListener(function(a,b,c){return f(a.url).done(function(a){c(a)}).fail(function(){c()}),!0})}function h(){location.href.match(/douban\.fm\/mine/i)&&(e(),d(),g())}var i=require("jquery"),j=require("js/helper"),k={};b.exports={init:h}});