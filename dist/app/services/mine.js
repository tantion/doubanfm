angular.module("fmApp").factory("mine",["$http","$q","$timeout",function(a,b,c){"use strict";function d(){var c=b.defer();return a({method:"get",url:"http://douban.fm/mine",timeout:3e4,withCredentials:!0}).success(function(a){var b=a.match(/window\.SP = "(.*)";/),d="";b&&b.length>1&&(d=b[1]),c.resolve(d)}).error(function(){c.reject()}),c.promise}function e(a){var c=b.defer();return chrome.cookies.get({url:"http://douban.fm/mine",name:a},function(a){if(a){var b=a.value||"";b=b.trim().replace(/^"(.*)"$/,"$1"),c.resolve(b)}else c.rejcet()}),c.promise}function f(){var a=b.defer();return chrome.tabs.query({url:"http://douban.fm/mine"},function(b){b&&b.length?a.resolve(b[0].id):chrome.tabs.create({url:"http://douban.fm/mine",active:!1},function(b){c(function(){a.resolve(b.id)},2e3)})}),a.promise}var g="",h={getApiUrl:function(a,c){var f=b.defer(),h="";return g?(h=g+"&start="+(a-1)*c,f.resolve(h)):b.all([e("ck"),e("bid"),d()]).then(function(b){var d=b[0],e=b[1],i=b[2];d?(g="http://douban.fm/j/play_record?ck="+d+"&spbid="+encodeURIComponent(i+e)+"&type=liked",h=g+"&start="+(a-1)*c,f.resolve(h)):f.reject()},function(){f.reject()}),f.promise},rethot:function(a){var c=b.defer();return b.all([f(),h.getApiUrl(a,15)]).then(function(a){var b=a[0],d=a[1];chrome.tabs.sendMessage(b,{url:d},function(a){a?c.resolve(a):c.reject()})}),c.promise}};return h}]);