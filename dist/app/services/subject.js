angular.module("fmApp").factory("subject",["$http","$q","helper",function(a,b,c){"use strict";var d={};return{loadSongs:function(e){var f=b.defer(),g="http://music.douban.com/subject/"+e,h=[];return d.hasOwnProperty(e)?(h=d[e],f.resolve(h)):a({method:"get",url:g,timeout:3e4,withCredentials:!0}).success(function(a){a=a.replace(/src=/gi,"data-src=");var b=$($.parseHTML(a)),i=b.find("#info").find(".pl").filter(function(){return $(this).text().indexOf("表演者")>-1?!0:void 0}).find("a"),j=b.find(".song-items-wrapper"),k=j.find(".song-item"),l=b.find("#db-tags-section").prev(),m="",n=$.trim(b.filter("#wrapper").children("h1").text()),o=$.trim(i.first().text()),p="http://music.douban.com"+i.attr("href");k.length?h=$.map(k,function(a){var b=$(a),d=b.attr("id"),f=b.data("ssid"),h=b.find(".song-name-short").data("title");return h?{id:d,ssid:f,title:c.fixFilename(h),album:n,fmUrl:c.fmUrl(d,f),albumUrl:g,albumId:e,artist:o,artistUrl:p}:void 0}):l.length&&(m=l.html().split(/<br\/?>/i),h=$.map(m,function(a,b){var d=$.trim(a),f=e+"-"+b;return d=d.match(/^([\d\.\- ]*) (.*)$/),d=d?d[2]:"",d?{id:f,title:c.fixFilename(d),album:n,albumUrl:g,albumId:e,artist:o,artistUrl:p}:void 0})),d[e]=h,f.resolve(h)}).error(function(){f.reject()}),f.promise}}}]);