angular.module("fmApp").factory("download",["$localStorage","$q","subject","musician","programme",function(a,b,c,d,e){"use strict";function f(a){var b={};return a.startTime?"complete"===a.state?(b.isReady=!0,b.isCompleted=!0,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1):"interrupted"===a.state?(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!0):"in_progress"===a.state?a.paused?a.canResume?(b.isReady=!1,b.isCompleted=!1,b.isPaused=!0,b.isDownloading=!1,b.isInterrupted=!1):(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1):(b.isReady=!1,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!0,b.isInterrupted=!1):(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1):a.state&&"complete"===a.state.current?(b.isReady=!0,b.isCompleted=!0,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1):a.error?(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!0):a.paused?a.paused.current?a.canResume.current?(b.isReady=!1,b.isCompleted=!1,b.isPaused=!0,b.isDownloading=!1,b.isInterrupted=!1):(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1):(b.isReady=!1,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!0,b.isInterrupted=!1):a.filename?(b.isReady=!1,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!0,b.isInterrupted=!1):(b.isReady=!0,b.isCompleted=!1,b.isPaused=!1,b.isDownloading=!1,b.isInterrupted=!1),b.downloadId=a.id,b}var g={add:function(b,c){var d=""+b.id;d&&c&&(a[d]={downloadId:c,title:b.title,artist:b.artist},a["did-"+c]=b.id)},updateStatus:function(a,b){var c=f(b);angular.extend(a,c)},findItem:function(c){c=""+c;var d=b.defer(),e=a[c],f=e?e.downloadId:"";return f&&chrome.downloads.search({id:f,exists:!0,query:[e.title,e.artist]},function(a){a&&a.length?d.resolve(a[0]):d.reject()}),d.promise},findSong:function(c,d){var e=a["did-"+d],f=b.defer(),g=null;if(e)for(var h=0,i=c.length;i>h;h+=1)if(c[h].id===e){g=c[h];break}return g&&chrome.downloads.search({id:d,exists:!0,query:[g.title,g.artist]},function(a){a&&a.length?f.resolve(g):f.reject()}),f.promise},loadSongs:function(a,f){var g=b.defer();switch(a){case"subject":c.loadSongs(f).then(function(a){var b=a&&a.length?a[0].album:"";g.resolve({songs:a,title:b})},function(){g.reject()});break;case"musician":d.loadSongs(f).then(function(a){var b=a&&a.length?a[0].artist:"";g.resolve({songs:a,title:b})},function(){g.reject()});break;case"programme":e.loadSongs(f).then(function(a){var b=a&&a.length?a[0].programme:"";g.resolve({songs:a,title:b})},function(){g.reject()});break;default:g.reject()}return g.promise}};return g}]);