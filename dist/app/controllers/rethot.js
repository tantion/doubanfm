angular.module("fmApp").controller("RethotController",["$scope","mine","baidu","download","$modal","_","async","$timeout",function(a,b,c,d,e,f,g,h){"use strict";function i(b){angular.forEach(a.data.songs,function(a){a.checked=b})}a.alert={},a.data={},a.status={},a.songs=[],a.allChecked=!1,a.page=0,a.loadRethot=function(c){a.page=c,b.rethot(c).then(function(b){a.data=b,angular.forEach(b.songs,function(a){d.findItem(a.id).then(function(b){d.updateStatus(a,b)})}),i(a.allChecked),a.status.error=!1,a.status.loaded=!0,b.songs.length||(a.status.ended=!0)},function(){a.status.error=!0})},a.downloadSong=function(a){c.search({title:a.title,artist:a.artist,album:a.subject_title}).then(function(b){a.url=b,chrome.downloads.download({filename:a.title+" - "+a.artist+".mp3",url:b},function(b){d.add(a,b),a.downloadId=b})},function(){a.error=!0})},a.downloadSongs=function(){a.downloadProcess=!0,g.eachSeries(a.songs,function(b,c){a.downloadSong(b),h(function(){c()},3e3)},function(){a.downloadProcess=!1})},a.pauseDownload=function(a){var b=a.downloadId;b&&chrome.downloads.pause(b,function(){a.isPaused=!0})},a.resumeDownload=function(a){var b=a.downloadId;b&&chrome.downloads.resume(b,function(){a.isPaused=!1})},chrome.downloads.onChanged.addListener(function(b){d.findSong(a.data.songs,b.id).then(function(a){d.updateStatus(a,b)})}),a.openUrlModal=function(){e.open({templateUrl:"partails/song-url.html",controller:"SongUrlController",resolve:{songs:function(){var b=angular.copy(a.songs);return b=f.map(b,function(a){return{title:a.title,artist:a.artist,album:a.subject_title}})}}})},a.playInFM=function(a,c){a.preventDefault(),seajs.use("js/fm-mine",function(a){a.findFMLink(c.id,c.path).done(function(a){c.fmLink=a,b.openOrUpdate(a,"http://douban.fm/?*")}).fail(function(){c.noFMLink=!0})})},a.toggleChecked=function(a,b){var c=a.target;"TD"===c.nodeName&&(b.checked=!b.checked)},a.$watch("data.songs",function(b){a.songs=f.filter(b,function(a){return a.checked})},!0),a.$watch("allChecked",function(a){i(a)}),a.loadRethot(1)}]);