angular.module("fmApp").controller("SearchController",["$scope","$location","download","$modal","_","async","$timeout",function(a,b,c,d,e,f,g){"use strict";function h(b){angular.forEach(a.data.songs,function(a){a.checked=b})}var i=b.search();a.query=i.query,a.alert={},a.data={},a.status={},a.songs=[],a.allChecked=!1,a.page=0,a.typeahead=function(a){return c.searchTypeahead(a)},a.search=function(){a.searching=!0,a.data.songs=[],c.searchByTitle(a.query).then(function(b){a.searching=!1,a.data=b,angular.forEach(b.songs,function(a){c.findItem(a.id).then(function(b){c.updateStatus(a,b)})}),h(a.allChecked),a.status.error=!1,a.status.loaded=!0,b.songs.length||(a.status.ended=!0)},function(){a.searching=!1,a.status.error=!0})},a.downloadSong=function(a){a.waiting=!0,c.searchById(a.song_id).then(function(b){a.url=b,chrome.downloads.download({filename:a.title+" - "+a.artist+".mp3",url:b},function(b){c.add(a,b),a.downloadId=b,a.waiting=!1})},function(){a.waiting=!1,a.error=!0})},a.downloadSongs=function(){a.downloadProcess=!0,f.eachSeries(a.songs,function(b,c){a.downloadSong(b),g(function(){c()},3e3)},function(){a.downloadProcess=!1})},a.pauseDownload=function(a){var b=a.downloadId;b&&chrome.downloads.pause(b,function(){a.isPaused=!0})},a.resumeDownload=function(a){var b=a.downloadId;b&&chrome.downloads.resume(b,function(){a.isPaused=!1})},chrome.downloads.onChanged.addListener(function(b){c.findSong(a.data.songs,b.id).then(function(a){c.updateStatus(a,b)})}),a.openUrlModal=function(){d.open({templateUrl:"partails/song-url.html",controller:"SongUrlController",resolve:{songs:function(){var b=angular.copy(a.songs);return b=e.map(b,function(a){return{title:a.title,artist:a.artist,album:a.album}})}}})},a.checkNeverDownload=function(){angular.forEach(a.data.songs,function(a){a.checked=a.isCompleted?!1:!0})},a.toggleChecked=function(a,b){var c=a.target;"TD"===c.nodeName&&(b.checked=!b.checked)},a.$watch("data.songs",function(b){a.songs=e.filter(b,function(a){return a.checked})},!0),a.$watch("allChecked",function(a){h(a)}),a.query&&a.search()}]);